<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Trading SOP Journal — V1</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #050816;
      color: #e5e7eb;
    }
    body {
      margin: 0;
      padding: 0;
      background: #020617;
      color: #e5e7eb;
    }
    .app {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
    }
    h1, h2, h3 {
      margin: 0 0 8px;
    }
    .modules {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }
    .module-card {
      background: #020817;
      border-radius: 10px;
      padding: 14px;
      border: 1px solid #1e293b;
      flex: 1 1 100%;
    }
    @media (min-width: 900px) {
      .module-card {
        flex: 1 1 calc(50% - 16px);
      }
    }
    .field-group {
      margin-bottom: 10px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      color: #9ca3af;
      margin-bottom: 2px;
    }
    input[type="text"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #1f2933;
      background: #020617;
      color: #e5e7eb;
      font-size: 0.9rem;
      box-sizing: border-box;
    }
    textarea {
      min-height: 60px;
      resize: vertical;
    }
    .row {
      display: flex;
      gap: 8px;
    }
    .row > .field-group {
      flex: 1;
    }
    .tag-input {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 4px;
      border-radius: 6px;
      border: 1px solid #1f2933;
      background: #020617;
      cursor: text;
    }
    .tag {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      background: #1f2937;
      font-size: 0.8rem;
    }
    .tag button {
      border: none;
      background: transparent;
      color: #9ca3af;
      margin-left: 4px;
      cursor: pointer;
      font-size: 0.8rem;
    }
    .tag-input input {
      border: none;
      outline: none;
      background: transparent;
      color: #e5e7eb;
      min-width: 80px;
      font-size: 0.85rem;
      padding: 2px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #1f2933;
      font-size: 0.8rem;
      gap: 4px;
    }
    .controls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: none;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .btn-primary {
      background: #22c55e;
      color: #020617;
      font-weight: 600;
    }
    .btn-danger {
      background: #ef4444;
      color: #f9fafb;
      font-weight: 500;
    }
    .status-pill {
      font-size: 0.8rem;
      color: #a1a1aa;
    }
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }
    .subtle {
      font-size: 0.75rem;
      color: #6b7280;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="controls">
      <h1>Trading SOP Journal — V1</h1>
      <div>
        <button id="resetDay" class="btn-danger">RESET DAY</button>
        <span id="saveStatus" class="status-pill"></span>
      </div>
    </div>
    <p class="subtle">
      4-section architecture (Pre-Market, During Session, Trade Idea Logic, Post-Market) with autosave +
      tag engine. V1 is front-end only; all behavior engines are wired as functions.
    </p>

    <div class="modules">
      <!-- MODULE 1 — PRE-MARKET (summary, key fields) -->
      <section class="module-card" id="module1">
        <div class="section-header">
          <h2>Module 1 — Pre-Market</h2>
          <span class="badge">Status: V1 wired</span>
        </div>

        <div class="field-group">
          <label for="m1_levels">Session Levels Marked</label>
          <textarea id="m1_levels" data-key="module1.levels"></textarea>
        </div>

        <div class="field-group">
          <label for="m1_bias">Previous Sessions Observed / Bias</label>
          <textarea id="m1_bias" data-key="module1.bias"></textarea>
        </div>

        <div class="field-group">
          <label for="m1_structure">HTF→LTF Structure &amp; Trend</label>
          <textarea id="m1_structure" data-key="module1.structure"></textarea>
        </div>

        <div class="field-group">
          <label>Confluence Tags (Pre-Market)</label>
          <div class="tag-input" data-key="module1.confluenceTags"></div>
        </div>

        <div class="field-group">
          <label for="m1_ifthen">IF–THEN Scenarios (raw)</label>
          <textarea id="m1_ifthen" data-key="module1.ifthens"></textarea>
        </div>

        <div class="row">
          <div class="field-group">
            <label for="m1_emotion">Session-Start Emotional State</label>
            <select id="m1_emotion" data-key="module1.emotion">
              <option value="">– select –</option>
              <option value="calm">Calm</option>
              <option value="focused">Focused</option>
              <option value="hesitant">Hesitant</option>
              <option value="anxious">Anxious</option>
              <option value="impatient">Impatient</option>
              <option value="overconfident">Overconfident</option>
            </select>
          </div>
          <div class="field-group">
            <label for="m1_emotionNotes">Emotion Clarifier</label>
            <input id="m1_emotionNotes" data-key="module1.emotionNotes" type="text" />
          </div>
        </div>

        <div class="field-group">
          <label>Expected Entry Models (optional)</label>
          <div class="tag-input" data-key="module1.expectedEntryModels"></div>
        </div>
      </section>

      <!-- MODULE 2 — DURING SESSION (GLOBAL) -->
      <section class="module-card" id="module2">
        <div class="section-header">
          <h2>Module 2 — During Session (Global)</h2>
          <span class="badge">Watching PA + emotions</span>
        </div>

        <div class="field-group">
          <label for="m2_notes">Global Session Notes</label>
          <textarea id="m2_notes" data-key="module2.sessionNotes"></textarea>
        </div>

        <div class="field-group">
          <label>Watching Price — Interpretation Tags</label>
          <div class="tag-input" data-key="module2.watchTags"></div>
        </div>

        <div class="row">
          <div class="field-group">
            <label for="m2_energy">Energy / Focus</label>
            <select id="m2_energy" data-key="module2.energy">
              <option value="">– select –</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="field-group">
            <label for="m2_energyNotes">Energy Notes</label>
            <input id="m2_energyNotes" data-key="module2.energyNotes" type="text" />
          </div>
        </div>
      </section>

      <!-- MODULE 3 — TRADE IDEA LOGIC -->
      <section class="module-card" id="module3">
        <div class="section-header">
          <h2>Module 3 — Trade Idea Logic</h2>
          <span class="badge">Trades + Missed Trades</span>
        </div>

        <div class="field-group">
          <button id="addTrade" class="btn-primary">Add Trade</button>
        </div>

        <div id="tradesContainer"></div>
      </section>

      <!-- MODULE 4 — POST-MARKET REVIEW -->
      <section class="module-card" id="module4">
        <div class="section-header">
          <h2>Module 4 — Post-Market Review</h2>
          <span class="badge">Auto + Semi-Auto</span>
        </div>

        <div class="field-group">
          <label>Daily Performance (AUTO summary)</label>
          <textarea id="m4_daily" data-key="module4.dailySummary" readonly></textarea>
          <p class="subtle">
            Populated from trades: PNL, R, missed R, missed opps, execution/discipline grades.
          </p>
        </div>

        <div class="field-group">
          <label>Market Behavior (multi-select tags)</label>
          <div class="tag-input" data-key="module4.marketBehavior"></div>
        </div>

        <div class="field-group">
          <label>Psychological Pattern Engine (AUTO)</label>
          <textarea id="m4_psych" data-key="module4.psychSummary" readonly></textarea>
        </div>

        <div class="field-group">
          <label>What Went Well (semi-auto + manual)</label>
          <textarea id="m4_well" data-key="module4.whatWentWell"></textarea>
        </div>

        <div class="field-group">
          <label>What Went Wrong (semi-auto + manual)</label>
          <textarea id="m4_wrong" data-key="module4.whatWentWrong"></textarea>
        </div>

        <div class="field-group">
          <label>Tomorrow’s Adjustments</label>
          <textarea id="m4_tomorrow" data-key="module4.tomorrow"></textarea>
        </div>

        <div class="row">
          <div class="field-group">
            <label for="m4_grade">Daily Grade</label>
            <select id="m4_grade" data-key="module4.grade">
              <option value="">– select –</option>
              <option value="A">A</option>
              <option value="B">B</option>
              <option value="C">C</option>
              <option value="D">D</option>
            </select>
          </div>
        </div>

        <button id="recomputePostMarket" class="btn-primary">Recompute Post-Market (V1)</button>
      </section>
    </div>
  </div>

  <script>
    // ---------- STATE & AUTOSAVE ----------
    const STORAGE_KEY = "trading_sop_v1_state";

    function getInitialState() {
      return {
        module1: {
          levels: "",
          bias: "",
          structure: "",
          confluenceTags: [],
          ifthens: "",
          emotion: "",
          emotionNotes: "",
          expectedEntryModels: []
        },
        module2: {
          sessionNotes: "",
          watchTags: [],
          energy: "",
          energyNotes: ""
        },
        module3: {
          trades: [] // array of trade objects
        },
        module4: {
          dailySummary: "",
          marketBehavior: [],
          psychSummary: "",
          whatWentWell: "",
          whatWentWrong: "",
          tomorrow: "",
          grade: ""
        }
      };
    }

    let appState = loadState();

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return getInitialState();
        return { ...getInitialState(), ...JSON.parse(raw) };
      } catch (e) {
        console.error("Failed to load state:", e);
        return getInitialState();
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(appState));
        setSaveStatus("Saved");
      } catch (e) {
        console.error("Failed to save state:", e);
        setSaveStatus("Save error");
      }
    }

    function setSaveStatus(msg) {
      const el = document.getElementById("saveStatus");
      if (!el) return;
      el.textContent = msg;
      if (!msg) return;
      setTimeout(() => {
        if (el.textContent === msg) el.textContent = "";
      }, 1500);
    }

    function resetDay() {
      appState = getInitialState();
      saveState();
      renderAll();
    }

    document.getElementById("resetDay").addEventListener("click", () => {
      if (confirm("Reset all fields for the day?")) resetDay();
    });

    // ---------- GENERIC BINDING HELPERS ----------
    function bindSimpleFields() {
      const elements = document.querySelectorAll("[data-key]");
      elements.forEach((el) => {
        if (el.classList.contains("tag-input")) return; // handled separately
        const keyPath = el.getAttribute("data-key");
        // init value
        el.value = getByPath(appState, keyPath) ?? "";
        el.addEventListener("input", () => {
          setByPath(appState, keyPath, el.value);
          saveState();
        });
      });
    }

    function getByPath(obj, path) {
      return path.split(".").reduce((acc, k) => (acc ? acc[k] : undefined), obj);
    }

    function setByPath(obj, path, value) {
      const parts = path.split(".");
      let current = obj;
      for (let i = 0; i < parts.length - 1; i++) {
        const k = parts[i];
        if (!current[k]) current[k] = {};
        current = current[k];
      }
      current[parts[parts.length - 1]] = value;
    }

    // ---------- TAG INPUT COMPONENT ----------
    function initTagInputs() {
      const tagInputs = document.querySelectorAll(".tag-input[data-key]");
      tagInputs.forEach((container) => {
        const keyPath = container.getAttribute("data-key");
        const tags = getByPath(appState, keyPath) || [];
        container.innerHTML = "";
        renderTags(container, keyPath, tags);
        attachTagInputBehavior(container, keyPath);
      });
    }

    function renderTags(container, keyPath, tags) {
      container.innerHTML = "";
      tags.forEach((tag, idx) => {
        const span = document.createElement("span");
        span.className = "tag";
        span.textContent = tag;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = "×";
        btn.addEventListener("click", () => {
          const arr = [...(getByPath(appState, keyPath) || [])];
          arr.splice(idx, 1);
          setByPath(appState, keyPath, arr);
          saveState();
          initTagInputs();
        });

        span.appendChild(btn);
        container.appendChild(span);
      });

      const input = document.createElement("input");
      input.type = "text";
      input.placeholder = "add tag…";
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === "," || e.key === " ") {
          e.preventDefault();
          commitTagInput(container, keyPath, input);
        }
      });
      input.addEventListener("blur", () => {
        commitTagInput(container, keyPath, input);
      });

      container.appendChild(input);
      container.addEventListener("click", () => input.focus());
    }

    function commitTagInput(container, keyPath, input) {
      const raw = input.value.trim();
      if (!raw) return;
      const pieces = raw.split(",").map((p) => p.trim()).filter(Boolean);
      if (!pieces.length) {
        input.value = "";
        return;
      }
      const existing = new Set(getByPath(appState, keyPath) || []);
      pieces.forEach((p) => existing.add(p));
      setByPath(appState, keyPath, Array.from(existing));
      input.value = "";
      saveState();
      initTagInputs();
    }

    function attachTagInputBehavior(container, keyPath) {
      // Already handled in renderTags
    }

    // ---------- MODULE 3: TRADES ----------
    function renderTrades() {
      const container = document.getElementById("tradesContainer");
      container.innerHTML = "";
      const trades = appState.module3.trades || [];
      trades.forEach((trade, idx) => {
        const card = document.createElement("div");
        card.style.border = "1px solid #1f2937";
        card.style.borderRadius = "8px";
        card.style.padding = "8px";
        card.style.marginBottom = "8px";
        card.style.background = "#020617";

        const header = document.createElement("div");
        header.className = "section-header";
        const title = document.createElement("h3");
        title.textContent = `Trade #${idx + 1} — ${trade.type || "executed/missed?"}`;
        title.style.fontSize = "0.9rem";
        const controls = document.createElement("div");

        const typeSelect = document.createElement("select");
        ["", "executed", "missed"].forEach((opt) => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt || "type?";
          if (trade.type === opt) o.selected = true;
          typeSelect.appendChild(o);
        });
        typeSelect.addEventListener("change", () => {
          trade.type = typeSelect.value || "";
          saveState();
          renderTrades();
        });

        const delBtn = document.createElement("button");
        delBtn.textContent = "Delete";
        delBtn.className = "btn-danger";
        delBtn.style.fontSize = "0.7rem";
        delBtn.addEventListener("click", () => {
          appState.module3.trades.splice(idx, 1);
          saveState();
          renderTrades();
          recomputePostMarket();
        });

        controls.appendChild(typeSelect);
        controls.appendChild(delBtn);
        header.appendChild(title);
        header.appendChild(controls);
        card.appendChild(header);

        // Pre-trade baseline emotion
        const baseline = document.createElement("div");
        baseline.className = "row";
        baseline.innerHTML = `
          <div class="field-group">
            <label>Pre-Trade Emotion</label>
            <input type="text" value="${trade.preEmotion || ""}">
          </div>
          <div class="field-group">
            <label>At-Signal Emotion</label>
            <input type="text" value="${trade.signalEmotion || ""}">
          </div>
        `;
        const [preInput, sigInput] = baseline.querySelectorAll("input");
        preInput.addEventListener("input", () => {
          trade.preEmotion = preInput.value;
          saveState();
        });
        sigInput.addEventListener("input", () => {
          trade.signalEmotion = sigInput.value;
          saveState();
        });
        card.appendChild(baseline);

        // Entry models (tag input)
        const entryModelsGroup = document.createElement("div");
        entryModelsGroup.className = "field-group";
        const emLabel = document.createElement("label");
        emLabel.textContent = "Entry Models (At-Signal / Executed or Missed)";
        entryModelsGroup.appendChild(emLabel);

        const emTags = document.createElement("div");
        emTags.className = "tag-input";
        const keyPath = `module3.trades.${idx}.entryModels`;
        setByPath(appState, keyPath, trade.entryModels || []);
        emTags.setAttribute("data-key", keyPath);
        entryModelsGroup.appendChild(emTags);
        card.appendChild(entryModelsGroup);

        // Risk model (executed only)
        if (trade.type === "executed") {
          const riskRow = document.createElement("div");
          riskRow.className = "row";
          riskRow.innerHTML = `
            <div class="field-group">
              <label>Risk Model</label>
              <select>
                <option value="">– select –</option>
                <option value="low">Low Risk</option>
                <option value="medium">Medium Risk</option>
                <option value="full">Full Risk</option>
              </select>
            </div>
            <div class="field-group">
              <label>Custom Risk Tags</label>
              <div class="tag-input"></div>
            </div>
          `;
          const select = riskRow.querySelector("select");
          select.value = trade.riskModel || "";
          select.addEventListener("change", () => {
            trade.riskModel = select.value;
            saveState();
          });

          const customRiskKey = `module3.trades.${idx}.riskTags`;
          setByPath(appState, customRiskKey, trade.riskTags || []);
          const riskTagDiv = riskRow.querySelector(".tag-input");
          riskTagDiv.setAttribute("data-key", customRiskKey);

          card.appendChild(riskRow);
        }

        // Basic PNL / R fields (for aggregation)
        const pnlRow = document.createElement("div");
        pnlRow.className = "row";
        pnlRow.innerHTML = `
          <div class="field-group">
            <label>Realized PNL</label>
            <input type="number" step="0.01" value="${trade.pnl ?? ""}">
          </div>
          <div class="field-group">
            <label>Realized R</label>
            <input type="number" step="0.01" value="${trade.realizedR ?? ""}">
          </div>
          <div class="field-group">
            <label>Missed R (for this trade)</label>
            <input type="number" step="0.01" value="${trade.missedR ?? ""}">
          </div>
        `;
        const [pnlInput, rInput, mrInput] = pnlRow.querySelectorAll("input");
        pnlInput.addEventListener("input", () => {
          trade.pnl = pnlInput.value === "" ? null : Number(pnlInput.value);
          saveState();
        });
        rInput.addEventListener("input", () => {
          trade.realizedR = rInput.value === "" ? null : Number(rInput.value);
          saveState();
        });
        mrInput.addEventListener("input", () => {
          trade.missedR = mrInput.value === "" ? null : Number(mrInput.value);
          saveState();
        });
        card.appendChild(pnlRow);

        container.appendChild(card);
      });

      initTagInputs();
    }

    document.getElementById("addTrade").addEventListener("click", () => {
      appState.module3.trades.push({
        type: "",
        preEmotion: "",
        signalEmotion: "",
        entryModels: [],
        riskModel: "",
        riskTags: [],
        pnl: null,
        realizedR: null,
        missedR: null
      });
      saveState();
      renderTrades();
    });

    // ---------- MODULE 4: POST-MARKET COMPUTATIONS (V1 STUBS) ----------
    function recomputePostMarket() {
      const trades = appState.module3.trades || [];

      let totalPnl = 0;
      let totalR = 0;
      let totalMissedR = 0;
      let missedCount = 0;

      trades.forEach((t) => {
        if (typeof t.pnl === "number") totalPnl += t.pnl;
        if (typeof t.realizedR === "number") totalR += t.realizedR;
        if (typeof t.missedR === "number") totalMissedR += t.missedR;
        if (t.type === "missed") missedCount += 1;
      });

      const dailySummary = [
        `Total PNL: ${totalPnl.toFixed(2)}`,
        `Total Realized R: ${totalR.toFixed(2)}`,
        `Total Missed R: ${totalMissedR.toFixed(2)}`,
        `Missed Opportunities: ${missedCount}`
      ].join(" | ");

      appState.module4.dailySummary = dailySummary;

      // Psych summary stub — V1: very simple narrative
      const hasHesitation = trades.some(
        (t) => (t.preEmotion || "").toLowerCase().includes("hesit") ||
               (t.signalEmotion || "").toLowerCase().includes("hesit")
      );
      const hasAggression = trades.some(
        (t) => (t.preEmotion || "").toLowerCase().includes("aggress") ||
               (t.signalEmotion || "").toLowerCase().includes("aggress")
      );

      let psychSummary = "Psych pattern engine (V1): ";
      if (hasHesitation && missedCount > 0) {
        psychSummary +=
          "Hesitation around the signal contributed to missed trades and unrealized R. ";
      }
      if (hasAggression && totalMissedR === 0 && totalR > 0) {
        psychSummary +=
          "Aggressive state aligned with execution and allowed you to capture R cleanly. ";
      }
      if (psychSummary === "Psych pattern engine (V1): ") {
        psychSummary += "No clear dominant pattern detected yet.";
      }

      appState.module4.psychSummary = psychSummary;

      saveState();
      // re-render simple bound fields
      const dailyEl = document.getElementById("m4_daily");
      const psychEl = document.getElementById("m4_psych");
      if (dailyEl) dailyEl.value = dailySummary;
      if (psychEl) psychEl.value = psychSummary;
    }

    document
      .getElementById("recomputePostMarket")
      .addEventListener("click", recomputePostMarket);

    // ---------- INITIALIZE ----------
    function renderAll() {
      bindSimpleFields();
      initTagInputs();
      renderTrades();
      // reflect computed module4 values
      const dailyEl = document.getElementById("m4_daily");
      const psychEl = document.getElementById("m4_psych");
      if (dailyEl) dailyEl.value = appState.module4.dailySummary || "";
      if (psychEl) psychEl.value = appState.module4.psychSummary || "";
    }

    renderAll();
  </script>
</body>
</html>
